{% extends 'base.html' %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/play.css') }}" />


{% if question is none %}
<div class="quiz-container">
  <div class="card">
    <!-- Decorative sparkles -->
    <div class="sparkle" style="top: 10%; left: 20%;"></div>
    <div class="sparkle" style="top: 70%; left: 80%;"></div>
    <div class="sparkle" style="top: 30%; left: 90%;"></div>
    <div class="sparkle" style="top: 80%; left: 10%;"></div>

    <div class="completion-container">
      <h1 class="completion-title">‡∂¥‡∑î‡∑Ñ‡∑î‡∂´‡∑î‡∑Ä ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä!</h1>
      <p class="completion-desc">‡∂î‡∂∂ ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª ‡∂á‡∂≠.</p>
      <a href="{{ url_for('kinesthetic.leaderboard') }}" class="btn btn-primary">
        <i class="fa fa-trophy"></i>
        ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±
      </a>
    </div>
  </div>
</div>
{% else %}
<div class="quiz-container">
  <div class="card">
    <!-- Decorative sparkles -->
    <div class="sparkle" style="top: 10%; left: 20%;"></div>
    <div class="sparkle" style="top: 70%; left: 80%;"></div>
    <div class="sparkle" style="top: 30%; left: 90%;"></div>
    <div class="sparkle" style="top: 80%; left: 10%;"></div>

    <!-- Progress indicator with modern style -->
    <div class="progress-container">
      <div class="progress-outer">
        <div class="progress-inner" style="width: {{ ((15 - (remaining_questions or 15)) * 100 / 15) }}%">
          <div class="progress-shine"></div>
        </div>
      </div>
      <div class="progress-text">{{ 15 - (remaining_questions or 15) }}/15 Questions</div>
    </div>

    <div class="alert">
      <i class="fa fa-info-circle"></i>
      <span class="alert-text">‡∂≠‡∑Ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± {{ remaining_questions or 15 }} ‡∂∫‡∑í</span>
    </div>

    <div class="question-content">
      <!-- Main question with HTML content and added colorful styling -->
      <div class="main-question-text">
        {{ question.text|safe }}
      </div>

      <!-- Single form for all sub-questions -->
      <form method="POST" action="{{ url_for('kinesthetic.process_all_answers') }}" class="all-answers-form"
        enctype="multipart/form-data" onsubmit="return submitAllAnswers(this, event)">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="question_pk" value="{{ question.id }}">
        <input type="hidden" name="answer_method" value="{{ question.answer_method }}">
        <input type="hidden" name="subject" value="{{ subject }}">

        <!-- Sub questions in accordion -->
        <div class="sub-questions-container">
          {% for sub_q in question.sub_questions %}
          <div class="sub-question">
            <button type="button" class="sub-question-header" onclick="toggleSubQuestion({{ loop.index }})">
              <span class="sub-question-title">{{ sub_q.text }}</span>
              <div class="sub-question-badges">
                <span class="badge badge-primary">‡∂Ω‡∂ö‡∑î‡∂´‡∑î {{ sub_q.points }}</span>
                <span class="badge badge-secondary">‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏ {{ sub_q.difficulty_level }}</span>
              </div>
              <div class="completion-indicator" id="completionIndicator{{ loop.index }}">
                <i class="fa fa-circle-o"></i>
              </div>
            </button>

            <div id="subQuestion{{ loop.index }}" class="sub-question-content">
              <input type="hidden" name="sub_question_ids" value="{{ sub_q.id }}">

              <!-- Instructions -->
              {% if sub_q.instructions %}
              <div class="alert alert-info">
                <i class="fa fa-info-circle"></i>
                <span class="alert-text">{{ sub_q.instructions }}</span>
              </div>
              {% endif %}

              <!-- Answer interface based on method -->
              <div class="answer-interface">
                <!-- Method-specific instructions with icons -->
                <h5 class="method-title">
                  {% if question.answer_method == 'abacus' %}
                  <i class="fa fa-calculator" style="color: #6366F1;"></i> ‡∂ú‡∂´‡∂ö ‡∂ª‡∑è‡∂∏‡∑î‡∑Ä (‡∂á‡∂∂‡∂ö‡∑É‡∂∫) ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% elif question.answer_method == 'analog_clock' %}
                  <i class="fa fa-clock-o" style="color: #6366F1;"></i> ‡∂Ö‡∂±‡∂Ω‡∑ú‡∂ú‡∑ä ‡∂î‡∂ª‡∂Ω‡∑ù‡∑É‡∑î‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% else %}
                  <i class="fa fa-desktop" style="color: #6366F1;"></i> ‡∂©‡∑í‡∂¢‡∑í‡∂ß‡∂Ω‡∑ä ‡∂î‡∂ª‡∂Ω‡∑ù‡∑É‡∑î‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% endif %}
                </h5>

                <!-- Answer constraints -->
                {% if sub_q.answer_type == 'number' and sub_q.min_value and sub_q.max_value %}
                <!-- <p class="constraint-text">
                  <i class="fa fa-ruler" style="color: #6B7280; margin-right: 5px;"></i>
                  ‡∂Ö‡∂ú‡∂∫ {{ sub_q.min_value }} ‡∑É‡∑Ñ {{ sub_q.max_value }} ‡∂Ö‡∂≠‡∂ª ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫
                </p> -->
                {% endif %}
                {% if sub_q.answer_type == 'time' and sub_q.time_format %}
                <p class="constraint-text">
                  <i class="fa fa-hourglass-half" style="color: #6B7280; margin-right: 5px;"></i>
                  ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä {{ sub_q.time_format }} ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫‡∂ß ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                </p>
                {% endif %}

                <!-- Webcam capture -->
                <div class="webcam-container">
                  <video id="webcam{{ loop.index }}" autoplay playsinline class="webcam-video"></video>
                  <button type="button" class="btn btn-primary mt-3" id="openCamera{{ loop.index }}"
                    onclick="openCamera('webcam{{ loop.index }}', this)">
                    <i class="fa fa-video-camera"></i> ‡∂ö‡∑ê‡∂∏‡∂ª‡∑è‡∑Ä ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                  </button>
                  <select id="cameraSelect{{ loop.index }}" class="form-control mt-2" style="display: none;"
                    onchange="switchCamera(this, 'webcam{{ loop.index }}')">
                    <option value="">‡∂ö‡∑ê‡∂∏‡∂ª‡∑è‡∑Ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±...</option>
                  </select>
                  <!-- Mirror button for clock questions (initially hidden) -->
                  <button type="button" class="btn btn-secondary mt-2" id="mirror{{ loop.index }}"
                    onclick="toggleMirror({{ loop.index }})" style="display: none;" data-mirrored="false">
                    <i class="fa fa-exchange"></i> ‡∂¥‡∑í‡∂Ç‡∂≠‡∑ñ‡∂ª‡∂∫ ‡∂¥‡∑ô‡∂ª‡∑Ö‡∂±‡∑ä‡∂±
                  </button>
                  <button type="button" class="btn btn-primary mt-3"
                    onclick="captureImage('webcam{{ loop.index }}', '{{ sub_q.id }}', {{ loop.index }})"
                    style="display: none;" id="capture{{ loop.index }}">
                    <i class="fa fa-camera"></i> ‡∂¥‡∑í‡∂Ç‡∂≠‡∑ñ‡∂ª‡∂∫ ‡∂ú‡∂±‡∑ä‡∂±
                  </button>
                </div>

                <!-- Hint section -->
                {% if sub_q.hint %}
                <div class="hint-section">
                  <button type="button" class="btn btn-hint" onclick="toggleHint({{ loop.index }})">
                    <i class="fa fa-lightbulb-o"></i>‡∂ã‡∂Ø‡∑Ä‡∑ä‡∑Ä‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±
                  </button>
                  <div id="hint{{ loop.index }}" class="hint-content" style="display: none;">
                    {{ sub_q.hint }}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Submit all answers button -->
        <div class="submit-all-container">
          <p class="answer-status">
            <span id="capturedAnswersCount">0</span> / <span id="totalSubQuestions">{{ question.sub_questions|length
              }}</span> ‡∂Ö‡∂±‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑É‡∂¥‡∂∫‡∑è ‡∂á‡∂≠
          </p>
          <button type="submit" class="btn btn-success submit-all-btn" id="submitAllBtn" disabled>
            <i class="fa fa-paper-plane"></i> ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <h3>‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...</h3>
    <p>‡∂Ö‡∂¥‡∑í ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∑É‡∑í‡∂ß‡∑í‡∂∏‡∑î, ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±.</p>
  </div>
</div>

<!-- Updated Result Modal for displaying multiple results -->
<div class="modal-overlay" id="resultModal">
  <div class="result-modal" id="resultModalContainer">
    <div class="bg-pattern"></div>
    <div class="modal-header">
      <div class="modal-icon" id="modalIcon">
        <!-- Icon will be dynamically set by JavaScript -->
      </div>
      <h3 class="modal-title" id="modalTitle">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!</h3>
    </div>

    <div class="modal-content">
      <!-- Results summary -->
      <div class="results-summary">
        <div class="summary-heading">‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫:</div>
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-label">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î:</span>
            <span class="stat-value correct-count" id="correctAnswersCount">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î:</span>
            <span class="stat-value wrong-count" id="wrongAnswersCount">0</span>
          </div>
        </div>
      </div>

      <!-- Detailed results for each sub-question -->
      <div class="detailed-results" id="detailedResults">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <button class="modal-btn" onclick="closeModalAndContinue()">
      <span class="emoji">üëç</span> ‡∂∏‡∑ì‡∑Ö‡∂ü ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫
    </button>
  </div>
</div>

<script src="{{ url_for('static', filename='js/play.js') }}"></script>

{% endif %}
{% endblock %}