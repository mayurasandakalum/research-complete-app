<!DOCTYPE html>
<html lang="si">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject_name }} පාඩම</title>

    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/subject_help.css') }}">
</head>

<body>
    <div class="video-container">
        <div class="video-header">
            <a href="{{ url_for('kinesthetic.user_home') }}" class="back-button">
                <i class="fa fa-arrow-left"></i> ආපසු
            </a>
            <h1>{{ subject_name }} පාඩම</h1>

            <!-- Show watched badge if video was previously watched -->
            {% if video_already_watched %}
            <div class="watched-badge">
                <i class="fa fa-check-circle"></i> නරඹා ඇත
            </div>
            {% endif %}
        </div>

        <div class="youtube-container">
            <!-- The player div will be replaced by the YouTube iframe -->
            <div class="youtube-player" id="player" data-video-id="{{ video_id }}">
                <!-- Loading indicator while YouTube API initializes -->
                <div class="loading-indicator">
                    <div class="spinner-border text-light" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-3 text-light">වීඩියෝව පූරණය වෙමින්...</p>
                </div>
            </div>
        </div>

        <!-- Add "Finished Watching" button -->
        <div class="video-actions">
            <button id="mark-watched-btn" class="btn btn-success" onclick="markVideoAsWatched()">
                <i class="fa fa-check-circle"></i> වීඩියෝව බලා අවසන්
            </button>
        </div>

        <div class="video-footer">
            <a href="{{ url_for('kinesthetic.play') }}" class="btn btn-primary">
                <i class="fa fa-play-circle"></i> පරීක්ෂණය ආරම්භ කරන්න
            </a>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>

    <!-- Custom script for YouTube player -->
    <script src="{{ url_for('static', filename='js/subject_help.js') }}"></script>

    <script>
        // Get the subject from the URL
        const pathParts = window.location.pathname.split('/');
        const subject = pathParts[pathParts.length - 1];

        // Add function to mark video as watched manually
        function markVideoAsWatched() {
            // Updated fetch URL: remove '/kinesthetic' since blueprint is registered without prefix
            fetch('/api/video-watched/' + subject, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // Remove CSRF token for now to simplify
                },
                body: JSON.stringify({ method: 'manual' })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Video marked as watched:', data);
                    const watchedBtn = document.getElementById('mark-watched-btn');
                    watchedBtn.innerHTML = '<i class="fa fa-check"></i> සම්පූර්ණයි!';
                    watchedBtn.classList.add('btn-watched');
                    watchedBtn.disabled = true;

                    const playerContainer = document.querySelector(".youtube-player").parentNode;
                    const completionMessage = document.createElement("div");
                    completionMessage.className = "video-completion-message";
                    completionMessage.textContent = "වීඩියෝව නැරඹීම සම්පූර්ණ කර ඇත!";
                    playerContainer.appendChild(completionMessage);

                    if (!document.querySelector('.watched-badge')) {
                        const header = document.querySelector('.video-header');
                        const watchedBadge = document.createElement('div');
                        watchedBadge.className = 'watched-badge';
                        watchedBadge.innerHTML = '<i class="fa fa-check-circle"></i> නරඹා ඇත';
                        header.appendChild(watchedBadge);
                    }
                    document.querySelector(".video-footer").scrollIntoView({ behavior: "smooth" });
                })
                .catch(error => {
                    console.error('Error marking video as watched:', error);
                    alert('වීඩියෝව සම්පූර්ණ ලෙස සලකුණු කිරීමේදී දෝෂයක් ඇති විය. කරුණාකර නැවත උත්සාහ කරන්න.');
                });
        }

        // Function to get CSRF token from meta or cookie
        function getCSRFToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) return metaTag.getAttribute('content');
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrf_token') return value;
            }
            return '';
        }

        // Disable the button if video is already watched
        document.addEventListener('DOMContentLoaded', function () {
            const isWatched = JSON.parse('{{ "true" if video_already_watched else "false" }}');
            if (isWatched) {
                const watchedBtn = document.getElementById('mark-watched-btn');
                watchedBtn.innerHTML = '<i class="fa fa-check"></i> දැනටමත් නරඹා ඇත';
                watchedBtn.classList.add('btn-watched');
                watchedBtn.disabled = true;
            }
        });
    </script>
</body>

</html>